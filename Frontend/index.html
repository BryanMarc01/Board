<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåç Tablero de Planes | Viajes y Salidas</title>
  <!-- Socket.io CDN -->
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <style>
    :root {
      --bg-gradient-from: #f8fafc;
      --bg-gradient-to: #e0f2fe;
      --board-bg: #ffffff;
      --board-border: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --note-shadow: rgba(0, 0, 0, 0.1);
      --modal-overlay: rgba(0, 0, 0, 0.5);
      
      /* Categor√≠as de colores */
      --restaurant-bg: #fee2e2;
      --restaurant-border: #fca5a5;
      --lodging-bg: #e0f2fe;
      --lodging-border: #7dd3fc;
      --activity-bg: #d1fae5;
      --activity-border: #6ee7b7;
      --nightlife-bg: #ede9fe;
      --nightlife-border: #c4b5fd;
      --beach-bg: #fef3c7;
      --beach-border: #fcd34d;
      --other-bg: #f3e8ff;
      --other-border: #d8b4fe;
      
      --white: #ffffff;
      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-300: #cbd5e1;
      --slate-400: #94a3b8;
      --slate-500: #64748b;
      --slate-600: #475569;
      --slate-700: #334155;
      --slate-800: #1e293b;
      --slate-900: #0f172a;
      --slate-950: #020617;
      
      --green-100: #dcfce7;
      --green-500: #22c55e;
      --green-800: #166534;
      --red-100: #fee2e2;
      --red-500: #ef4444;
      --red-800: #991b1b;
      --blue-500: #3b82f6;
      
      --radius-sm: 0.25rem;
      --radius-md: 0.375rem;
      --radius-lg: 0.5rem;
      --radius-xl: 0.75rem;
      --radius-full: 9999px;
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    .dark {
      --bg-gradient-from: #0f172a;
      --bg-gradient-to: #0c4a6e;
      --board-bg: #020617;
      --board-border: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      
      /* Categor√≠as de colores en modo oscuro */
      --restaurant-bg: #7f1d1d;
      --restaurant-border: #b91c1c;
      --lodging-bg: #0c4a6e;
      --lodging-border: #0369a1;
      --activity-bg: #064e3b;
      --activity-border: #047857;
      --nightlife-bg: #4c1d95;
      --nightlife-border: #6d28d9;
      --beach-bg: #78350f;
      --beach-border: #b45309;
      --other-bg: #581c87;
      --other-border: #7e22ce;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-sans);
      background: linear-gradient(to bottom right, var(--bg-gradient-from), var(--bg-gradient-to));
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      font-size: 16px;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    h1 {
      font-size: 1.875rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .connection-status {
      margin-left: 1rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .status-connected {
      background-color: var(--green-100);
      color: var(--green-800);
    }

    .status-disconnected {
      background-color: var(--red-100);
      color: var(--red-800);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      outline: none;
    }

    .btn-primary {
      background: linear-gradient(to right, #3b82f6, #0ea5e9);
      color: var(--white);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-primary:hover {
      background: linear-gradient(to right, #2563eb, #0284c7);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-icon {
      width: 1.5rem;
      height: 1.5rem;
      padding: 0;
      border-radius: var(--radius-full);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-ghost {
      background: transparent;
      color: var(--slate-600);
    }

    .btn-ghost:hover {
      background-color: rgba(255, 255, 255, 0.5);
    }

    .btn-danger:hover {
      background-color: var(--red-100);
      color: var(--red-500);
    }

    .icon {
      width: 1rem;
      height: 1rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }

    .icon-sm {
      width: 0.75rem;
      height: 0.75rem;
    }

    .mr-2 {
      margin-right: 0.5rem;
    }

    .board {
      position: relative;
      width: 100%;
      min-height: calc(100vh - 8rem);
      background-color: var(--board-bg);
      border-radius: var(--radius-xl);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--board-border);
      overflow: hidden;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
    }

    .note {
      position: absolute;
      padding: 0;
      border-radius: var(--radius-lg);
      box-shadow: 0 2px 8px var(--note-shadow);
      transition: all 0.2s ease;
      width: 280px;
      border-width: 2px;
      border-style: solid;
      background-color: var(--white);
    }

    .note.dragging {
      box-shadow: 0 8px 16px var(--note-shadow);
      z-index: 100;
    }

    .note-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem;
      border-bottom: 1px solid;
      border-bottom-color: inherit;
      background-color: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(4px);
    }

    .note-header-left {
      display: flex;
      align-items: center;
    }

    .note-title {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--slate-700);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-left: 0.5rem;
    }

    .dark .note-title {
      color: var(--slate-300);
    }

    .note-actions {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .note-content {
      padding: 0.75rem;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--slate-700);
      min-height: 80px;
      max-height: 300px;
      overflow-y: auto;
    }

    .dark .note-content {
      color: var(--slate-300);
    }

    .note-link {
      display: block;
      margin-top: 0.5rem;
      padding: 0.5rem;
      background-color: rgba(0, 0, 0, 0.03);
      border-radius: var(--radius-md);
      color: var(--blue-500);
      text-decoration: none;
      word-break: break-all;
      transition: background-color 0.2s;
    }

    .note-link:hover {
      background-color: rgba(0, 0, 0, 0.05);
      text-decoration: underline;
    }

    .dark .note-link {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .dark .note-link:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .link-preview {
      margin-top: 0.75rem;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--slate-200);
    }

    .dark .link-preview {
      border-color: var(--slate-700);
    }

    .preview-image {
      width: 100%;
      height: 140px;
      object-fit: cover;
      background-color: var(--slate-100);
    }

    .preview-content {
      padding: 0.75rem;
    }

    .preview-title {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
      color: var(--slate-800);
    }

    .dark .preview-title {
      color: var(--slate-200);
    }

    .preview-description {
      font-size: 0.75rem;
      color: var(--slate-600);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .dark .preview-description {
      color: var(--slate-400);
    }

    .preview-domain {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--slate-500);
    }

    .category-picker {
      position: absolute;
      right: 0.5rem;
      top: 2.5rem;
      background-color: var(--white);
      padding: 0.5rem;
      border-radius: var(--radius-md);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--slate-200);
      z-index: 50;
      width: 180px;
    }

    .dark .category-picker {
      background-color: var(--slate-800);
      border-color: var(--slate-700);
    }

    .category-option {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .category-option:hover {
      background-color: var(--slate-100);
    }

    .dark .category-option:hover {
      background-color: var(--slate-700);
    }

    .category-color {
      width: 1rem;
      height: 1rem;
      border-radius: var(--radius-full);
      margin-right: 0.5rem;
    }

    .category-label {
      font-size: 0.875rem;
      color: var(--slate-700);
    }

    .dark .category-label {
      color: var(--slate-300);
    }

    .category-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 500;
      margin-top: 0.5rem;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--modal-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 28rem;
      transform: scale(0.95);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .dark .modal-content {
      background-color: var(--slate-900);
      border: 1px solid var(--slate-800);
    }

    .modal-overlay.active .modal-content {
      transform: scale(1);
      opacity: 1;
    }

    .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--slate-200);
    }

    .dark .modal-header {
      border-color: var(--slate-800);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--slate-800);
    }

    .dark .modal-title {
      color: var(--slate-200);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--slate-200);
    }

    .dark .modal-footer {
      border-color: var(--slate-800);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--slate-700);
    }

    .dark .form-label {
      color: var(--slate-300);
    }

    .textarea, .input {
      width: 100%;
      border: 1px solid var(--slate-300);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      font-family: inherit;
      font-size: 1rem;
      color: var(--slate-800);
      outline: none;
      transition: border-color 0.2s ease;
      background-color: var(--white);
    }

    .dark .textarea, .dark .input {
      border-color: var(--slate-700);
      background-color: var(--slate-900);
      color: var(--slate-200);
    }

    .textarea {
      min-height: 100px;
      resize: none;
    }

    .textarea:focus, .input:focus {
      border-color: var(--blue-500);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .select {
      width: 100%;
      border: 1px solid var(--slate-300);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      font-family: inherit;
      font-size: 1rem;
      color: var(--slate-800);
      outline: none;
      transition: border-color 0.2s ease;
      background-color: var(--white);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1rem;
      padding-right: 2rem;
    }

    .dark .select {
      border-color: var(--slate-700);
      background-color: var(--slate-900);
      color: var(--slate-200);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    }

    .keyboard-hint {
      font-size: 0.75rem;
      color: var(--slate-500);
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
    }

    .btn-secondary {
      background-color: var(--white);
      color: var(--slate-800);
      border: 1px solid var(--slate-300);
    }

    .dark .btn-secondary {
      background-color: var(--slate-800);
      color: var(--slate-200);
      border-color: var(--slate-700);
    }

    .btn-secondary:hover {
      background-color: var(--slate-100);
    }

    .dark .btn-secondary:hover {
      background-color: var(--slate-700);
    }

    .hidden {
      display: none;
    }

    /* Categor√≠as de notas */
    .category-restaurant {
      background-color: var(--restaurant-bg);
      border-color: var(--restaurant-border);
    }

    .category-lodging {
      background-color: var(--lodging-bg);
      border-color: var(--lodging-border);
    }

    .category-activity {
      background-color: var(--activity-bg);
      border-color: var(--activity-border);
    }

    .category-nightlife {
      background-color: var(--nightlife-bg);
      border-color: var(--nightlife-border);
    }

    .category-beach {
      background-color: var(--beach-bg);
      border-color: var(--beach-border);
    }

    .category-other {
      background-color: var(--other-bg);
      border-color: var(--other-border);
    }

    /* Responsive styles */
    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .note {
        width: 250px;
      }
    }

    /* Dark mode toggle */
    .theme-toggle {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background-color: var(--white);
      border: 1px solid var(--slate-200);
      border-radius: var(--radius-full);
      padding: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      z-index: 10;
    }

    .dark .theme-toggle {
      background-color: var(--slate-800);
      border-color: var(--slate-700);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <h1>üåç Tablero de Planes</h1>
        <div id="connectionStatus" class="connection-status status-disconnected">Desconectado</div>
      </div>
      <button id="addNoteBtn" class="btn btn-primary">
        <svg class="icon mr-2" viewBox="0 0 24 24">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        A√±adir Plan
      </button>
    </header>

    <div id="board" class="board">
      <!-- Las notas se a√±adir√°n din√°micamente aqu√≠ -->
    </div>
  </div>

  <!-- Modal para crear/editar notas -->
  <div id="noteModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle" class="modal-title">Crear Nuevo Plan</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="noteTitle" class="form-label">T√≠tulo</label>
          <input type="text" id="noteTitle" class="input" placeholder="T√≠tulo del plan">
        </div>
        <div class="form-group">
          <label for="noteContent" class="form-label">Descripci√≥n</label>
          <textarea id="noteContent" class="textarea" placeholder="Describe el lugar o actividad..."></textarea>
        </div>
        <div class="form-group">
          <label for="noteLink" class="form-label">Enlace (Airbnb, Google Maps, etc.)</label>
          <input type="url" id="noteLink" class="input" placeholder="https://...">
        </div>
        <div class="form-group">
          <label for="noteCategory" class="form-label">Categor√≠a</label>
          <select id="noteCategory" class="select">
            <option value="restaurant">üçΩÔ∏è Restaurante</option>
            <option value="lodging">üè† Alojamiento</option>
            <option value="activity">üéØ Actividad</option>
            <option value="nightlife">üåÉ Vida nocturna</option>
            <option value="beach">üèñÔ∏è Playa</option>
            <option value="other">üìå Otro</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <div class="keyboard-hint">Presiona Ctrl+Enter para guardar</div>
        <div class="btn-group">
          <button id="cancelBtn" class="btn btn-secondary">Cancelar</button>
          <button id="saveNoteBtn" class="btn btn-primary">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dark mode toggle -->
  <button id="themeToggle" class="theme-toggle">
    <svg id="sunIcon" class="icon" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
    <svg id="moonIcon" class="icon hidden" viewBox="0 0 24 24">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </button>

  <script>
    // DOM Elements
    const board = document.getElementById('board');
    const noteModal = document.getElementById('noteModal');
    const modalTitle = document.getElementById('modalTitle');
    const noteTitle = document.getElementById('noteTitle');
    const noteContent = document.getElementById('noteContent');
    const noteLink = document.getElementById('noteLink');
    const noteCategory = document.getElementById('noteCategory');
    const addNoteBtn = document.getElementById('addNoteBtn');
    const saveNoteBtn = document.getElementById('saveNoteBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const themeToggle = document.getElementById('themeToggle');
    const sunIcon = document.getElementById('sunIcon');
    const moonIcon = document.getElementById('moonIcon');

    // Application State
    let notes = [];
    let activeNoteId = null;
    let isDragging = false;
    let draggedNote = null;
    let dragOffset = { x: 0, y: 0 };
    let highestZIndex = 1;
    let showCategoryPicker = null;

    // Categor√≠as disponibles
    const categories = [
      { value: 'restaurant', label: 'üçΩÔ∏è Restaurante', class: 'category-restaurant' },
      { value: 'lodging', label: 'üè† Alojamiento', class: 'category-lodging' },
      { value: 'activity', label: 'üéØ Actividad', class: 'category-activity' },
      { value: 'nightlife', label: 'üåÉ Vida nocturna', class: 'category-nightlife' },
      { value: 'beach', label: 'üèñÔ∏è Playa', class: 'category-beach' },
      { value: 'other', label: 'üìå Otro', class: 'category-other' }
    ];

    // Initialize Socket.io
    const socket = io("https://backend-devnotess.onrender.com");

    // Socket.io event handlers
    socket.on('connect', () => {
      console.log('‚úÖ Conectado al servidor');
      connectionStatus.textContent = 'Conectado';
      connectionStatus.classList.remove('status-disconnected');
      connectionStatus.classList.add('status-connected');
    });

    socket.on('disconnect', () => {
      connectionStatus.textContent = 'Desconectado';
      connectionStatus.classList.remove('status-connected');
      connectionStatus.classList.add('status-disconnected');
    });

    socket.on('loadNotes', loadedNotes => {
      notes = loadedNotes.map(note => ({
        ...note,
        title: note.title || extractTitle(note.content),
        link: note.link || extractLink(note.content),
        category: note.category || 'other',
        color: getCategoryClass(note.category || 'other'),
        zIndex: note.zIndex || 1,
        minimized: note.minimized || false
      }));
      
      // Find highest z-index
      highestZIndex = Math.max(...notes.map(n => n.zIndex || 1), 1);
      renderAllNotes();
    });

    socket.on('newNote', note => {
      const newNote = {
        ...note,
        title: note.title || extractTitle(note.content),
        link: note.link || extractLink(note.content),
        category: note.category || 'other',
        color: getCategoryClass(note.category || 'other'),
        zIndex: note.zIndex || highestZIndex + 1,
        minimized: note.minimized || false
      };
      notes.push(newNote);
      renderNote(newNote);
      highestZIndex = Math.max(highestZIndex, newNote.zIndex);
    });

    socket.on('updateNote', updatedNote => {
      notes = notes.map(note => 
        note.id === updatedNote.id ? {
          ...updatedNote,
          title: updatedNote.title || extractTitle(updatedNote.content),
          link: updatedNote.link || extractLink(updatedNote.content),
          category: updatedNote.category || 'other',
          color: getCategoryClass(updatedNote.category || 'other'),
          zIndex: updatedNote.zIndex || note.zIndex,
          minimized: updatedNote.minimized !== undefined ? updatedNote.minimized : note.minimized
        } : note
      );
      
      updateNoteElement(updatedNote);
      
      if (updatedNote.zIndex && updatedNote.zIndex > highestZIndex) {
        highestZIndex = updatedNote.zIndex;
      }
    });

    socket.on('deleteNote', noteId => {
      notes = notes.filter(note => note.id !== noteId);
      const noteElement = document.getElementById(`note-${noteId}`);
      if (noteElement) noteElement.remove();
    });

    // Helper functions
    function extractTitle(content) {
      if (!content) return 'Sin t√≠tulo';
      const firstLine = content.split('\n')[0];
      return firstLine.substring(0, 30) + (firstLine.length > 30 ? '...' : '');
    }

    function extractLink(content) {
      if (!content) return '';
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      const matches = content.match(urlRegex);
      return matches ? matches[0] : '';
    }

    function getCategoryClass(categoryValue) {
      const category = categories.find(c => c.value === categoryValue);
      return category ? category.class : 'category-other';
    }

    function getCategoryLabel(categoryValue) {
      const category = categories.find(c => c.value === categoryValue);
      return category ? category.label : 'üìå Otro';
    }

    function getDomainFromUrl(url) {
      if (!url) return '';
      try {
        const domain = new URL(url).hostname;
        return domain.replace('www.', '');
      } catch (e) {
        return '';
      }
    }

    // Functions to handle notes
    function renderAllNotes() {
      board.innerHTML = '';
      notes.forEach(renderNote);
    }

    function renderNote(note) {
      // Check if note already exists
      const existingNote = document.getElementById(`note-${note.id}`);
      if (existingNote) {
        updateNoteElement(note);
        return;
      }

      // Create note element
      const noteElement = document.createElement('div');
      noteElement.id = `note-${note.id}`;
      noteElement.className = `note ${note.color || 'category-other'}`;
      noteElement.style.transform = `translate(${note.x}px, ${note.y}px)`;
      noteElement.style.zIndex = note.zIndex || 1;
      
      // Note header with title and actions
      const headerHTML = `
        <div class="note-header">
          <div class="note-header-left">
            <svg class="icon icon-sm" viewBox="0 0 24 24">
              <line x1="4" y1="9" x2="20" y2="9"></line>
              <line x1="4" y1="15" x2="20" y2="15"></line>
            </svg>
            <span class="note-title">${note.title || extractTitle(note.content)}</span>
          </div>
          <div class="note-actions">
            <button class="btn btn-icon btn-ghost category-btn" title="Cambiar categor√≠a">
              <svg class="icon icon-sm" viewBox="0 0 24 24">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                <line x1="7" y1="7" x2="7.01" y2="7"></line>
              </svg>
            </button>
            <button class="btn btn-icon btn-ghost edit-btn" title="Editar plan">
              <svg class="icon icon-sm" viewBox="0 0 24 24">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
            <button class="btn btn-icon btn-ghost minimize-btn" title="${note.minimized ? 'Maximizar' : 'Minimizar'}">
              <svg class="icon icon-sm ${note.minimized ? 'hidden' : ''}" viewBox="0 0 24 24">
                <polyline points="8 3 18 3 18 13"></polyline>
                <polyline points="16 8 21 3 16 8"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
              <svg class="icon icon-sm ${note.minimized ? '' : 'hidden'}" viewBox="0 0 24 24">
                <polyline points="15 3 21 3 21 9"></polyline>
                <polyline points="9 21 3 21 3 15"></polyline>
                <line x1="21" y1="3" x2="14" y2="10"></line>
                <line x1="3" y1="21" x2="10" y2="14"></line>
              </svg>
            </button>
            <button class="btn btn-icon btn-ghost btn-danger delete-btn" title="Eliminar plan">
              <svg class="icon icon-sm" viewBox="0 0 24 24">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </div>
        <div class="category-picker hidden"></div>
      `;
      
      noteElement.innerHTML = headerHTML;
      
      // Add note content if not minimized
      if (!note.minimized) {
        const contentDiv = document.createElement('div');
        contentDiv.className = 'note-content';
        
        // Contenido principal
        contentDiv.textContent = note.content;
        
        // A√±adir enlace si existe
        if (note.link) {
          const linkElement = document.createElement('a');
          linkElement.href = note.link;
          linkElement.className = 'note-link';
          linkElement.textContent = note.link;
          linkElement.target = '_blank';
          linkElement.rel = 'noopener noreferrer';
          contentDiv.appendChild(linkElement);
          
          // Intentar crear una vista previa del enlace
          createLinkPreview(note.link, contentDiv);
        }
        
        // A√±adir badge de categor√≠a
        const categoryBadge = document.createElement('div');
        categoryBadge.className = `category-badge ${note.color}`;
        categoryBadge.textContent = getCategoryLabel(note.category);
        contentDiv.appendChild(categoryBadge);
        
        noteElement.appendChild(contentDiv);
      }
      
      board.appendChild(noteElement);
      
      // Set up category picker
      const categoryPicker = noteElement.querySelector('.category-picker');
      categories.forEach(category => {
        const categoryOption = document.createElement('div');
        categoryOption.className = 'category-option';
        categoryOption.innerHTML = `
          <div class="category-color ${category.class}"></div>
          <div class="category-label">${category.label}</div>
        `;
        
        categoryOption.addEventListener('click', () => {
          changeNoteCategory(note.id, category.value);
          categoryPicker.classList.add('hidden');
        });
        
        categoryPicker.appendChild(categoryOption);
      });
      
      // Set up event handlers
      setupNoteEvents(noteElement, note.id);
    }

    function updateNoteElement(note) {
      const noteElement = document.getElementById(`note-${note.id}`);
      if (!noteElement) return;
      
      // Update position and z-index
      noteElement.style.transform = `translate(${note.x}px, ${note.y}px)`;
      noteElement.style.zIndex = note.zIndex || 1;
      
      // Update title
      const titleElement = noteElement.querySelector('.note-title');
      if (titleElement) {
        titleElement.textContent = note.title || extractTitle(note.content);
      }
      
      // Update color/category
      noteElement.className = `note ${note.color || getCategoryClass(note.category) || 'category-other'}`;
      
      // Update minimize/maximize state
      const minimizeBtn = noteElement.querySelector('.minimize-btn');
      const minimizeIconHide = minimizeBtn.querySelector('svg:first-child');
      const maximizeIconHide = minimizeBtn.querySelector('svg:last-child');
      
      if (note.minimized) {
        minimizeIconHide.classList.add('hidden');
        maximizeIconHide.classList.remove('hidden');
        
        // Remove content if minimized
        const contentElement = noteElement.querySelector('.note-content');
        if (contentElement) {
          contentElement.remove();
        }
      } else {
        minimizeIconHide.classList.remove('hidden');
        maximizeIconHide.classList.add('hidden');
        
        // Add content if not minimized and doesn't exist
        if (!noteElement.querySelector('.note-content')) {
          const contentDiv = document.createElement('div');
          contentDiv.className = 'note-content';
          contentDiv.textContent = note.content;
          
          // A√±adir enlace si existe
          if (note.link) {
            const linkElement = document.createElement('a');
            linkElement.href = note.link;
            linkElement.className = 'note-link';
            linkElement.textContent = note.link;
            linkElement.target = '_blank';
            linkElement.rel = 'noopener noreferrer';
            contentDiv.appendChild(linkElement);
            
            // Intentar crear una vista previa del enlace
            createLinkPreview(note.link, contentDiv);
          }
          
          // A√±adir badge de categor√≠a
          const categoryBadge = document.createElement('div');
          categoryBadge.className = `category-badge ${note.color}`;
          categoryBadge.textContent = getCategoryLabel(note.category);
          contentDiv.appendChild(categoryBadge);
          
          noteElement.appendChild(contentDiv);
        } else {
          // Update content if it exists
          const contentElement = noteElement.querySelector('.note-content');
          contentElement.textContent = note.content;
          
          // Actualizar o a√±adir enlace
          let linkElement = contentElement.querySelector('.note-link');
          if (note.link) {
            if (!linkElement) {
              linkElement = document.createElement('a');
              linkElement.className = 'note-link';
              linkElement.target = '_blank';
              linkElement.rel = 'noopener noreferrer';
              contentElement.appendChild(linkElement);
              
              // Intentar crear una vista previa del enlace
              createLinkPreview(note.link, contentElement);
            }
            linkElement.href = note.link;
            linkElement.textContent = note.link;
          } else if (linkElement) {
            linkElement.remove();
            const previewElement = contentElement.querySelector('.link-preview');
            if (previewElement) previewElement.remove();
          }
          
          // Actualizar badge de categor√≠a
          let categoryBadge = contentElement.querySelector('.category-badge');
          if (!categoryBadge) {
            categoryBadge = document.createElement('div');
            categoryBadge.className = 'category-badge';
            contentElement.appendChild(categoryBadge);
          }
          categoryBadge.className = `category-badge ${note.color}`;
          categoryBadge.textContent = getCategoryLabel(note.category);
        }
      }
    }

    function createLinkPreview(url, container) {
      // Verificar si ya existe una vista previa
      if (container.querySelector('.link-preview')) return;
      
      // Crear elemento de vista previa b√°sica
      const previewElement = document.createElement('div');
      previewElement.className = 'link-preview';
      
      const domain = getDomainFromUrl(url);
      
      // Determinar qu√© tipo de vista previa crear basado en el dominio
      if (url.includes('airbnb.com')) {
        previewElement.innerHTML = `
          <div class="preview-image" style="background-color: #FF5A5F; display: flex; align-items: center; justify-content: center;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="#FFFFFF">
              <path d="M12 2C14.5 2 16.5 4 16.5 6.5C16.5 9 15 11 13 12.5C12.5 13 11.5 13 11 12.5C9 11 7.5 9 7.5 6.5C7.5 4 9.5 2 12 2M12 4C10.5 4 9.5 5 9.5 6.5C9.5 8 10.5 9.5 12 10.5C13.5 9.5 14.5 8 14.5 6.5C14.5 5 13.5 4 12 4M14 13C16.5 13 18.5 15 18.5 17.5C18.5 20 16.5 22 14 22H10C7.5 22 5.5 20 5.5 17.5C5.5 15 7.5 13 10 13H14M10 15C8.5 15 7.5 16 7.5 17.5C7.5 19 8.5 20 10 20H14C15.5 20 16.5 19 16.5 17.5C16.5 16 15.5 15 14 15H10Z" />
            </svg>
          </div>
          <div class="preview-content">
            <div class="preview-title">Alojamiento en Airbnb</div>
            <div class="preview-description">Ver detalles del alojamiento en Airbnb</div>
            <div class="preview-domain">${domain}</div>
          </div>
        `;
      } else if (url.includes('maps.google') || url.includes('goo.gl/maps')) {
        previewElement.innerHTML = `
          <div class="preview-image" style="background-color: #4285F4; display: flex; align-items: center; justify-content: center;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="#FFFFFF">
              <path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z" />
            </svg>
          </div>
          <div class="preview-content">
            <div class="preview-title">Ubicaci√≥n en Google Maps</div>
            <div class="preview-description">Ver ubicaci√≥n en el mapa</div>
            <div class="preview-domain">${domain}</div>
          </div>
        `;
      } else if (url.includes('tripadvisor')) {
        previewElement.innerHTML = `
          <div class="preview-image" style="background-color: #00AA6C; display: flex; align-items: center; justify-content: center;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="#FFFFFF">
              <path d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M12,4C16.42,4 20,7.58 20,12C20,16.42 16.42,20 12,20C7.58,20 4,16.42 4,12C4,7.58 7.58,4 12,4M10,8C8.9,8 8,8.9 8,10C8,11.1 8.9,12 10,12C11.1,12 12,11.1 12,10C12,8.9 11.1,8 10,8M14,8C12.9,8 12,8.9 12,10C12,11.1 12.9,12 14,12C15.1,12 16,11.1 16,10C16,8.9 15.1,8 14,8M7,14C7,15.66 9.34,17 12,17C14.66,17 17,15.66 17,14H7Z" />
            </svg>
          </div>
          <div class="preview-content">
            <div class="preview-title">Rese√±as en TripAdvisor</div>
            <div class="preview-description">Ver opiniones y rese√±as</div>
            <div class="preview-domain">${domain}</div>
          </div>
        `;
      } else {
        // Vista previa gen√©rica para otros sitios
        previewElement.innerHTML = `
          <div class="preview-image" style="background-color: #f1f5f9; display: flex; align-items: center; justify-content: center;">
            <svg class="icon" style="width: 40px; height: 40px;" viewBox="0 0 24 24">
              <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z" fill="#64748b" />
            </svg>
          </div>
          <div class="preview-content">
            <div class="preview-title">Enlace externo</div>
            <div class="preview-description">Visitar sitio web</div>
            <div class="preview-domain">${domain}</div>
          </div>
        `;
      }
      
      container.appendChild(previewElement);
    }

    function setupNoteEvents(noteElement, noteId) {
      // Edit button
      noteElement.querySelector('.edit-btn').addEventListener('click', () => {
        editNote(noteId);
      });
      
      // Delete button
      noteElement.querySelector('.delete-btn').addEventListener('click', () => {
        deleteNote(noteId);
      });
      
      // Category button
      noteElement.querySelector('.category-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const categoryPicker = noteElement.querySelector('.category-picker');
        
        // Close any other open category pickers
        if (showCategoryPicker && showCategoryPicker !== noteId) {
          const otherPicker = document.querySelector(`#note-${showCategoryPicker} .category-picker`);
          if (otherPicker) otherPicker.classList.add('hidden');
        }
        
        categoryPicker.classList.toggle('hidden');
        showCategoryPicker = categoryPicker.classList.contains('hidden') ? null : noteId;
      });
      
      // Minimize/Maximize button
      noteElement.querySelector('.minimize-btn').addEventListener('click', () => {
        toggleMinimize(noteId);
      });
      
      // Drag events
      noteElement.addEventListener('mousedown', (e) => {
        // Don't start drag if clicked on a button
        if (e.target.closest('button') || e.target.closest('a')) return;
        
        startDrag(e, noteId);
      });
      
      // Bring to front on click
      noteElement.addEventListener('click', () => {
        bringToFront(noteId);
      });
    }

    function startDrag(e, noteId) {
      const note = notes.find(n => n.id === noteId);
      if (!note) return;
      
      isDragging = true;
      draggedNote = noteId;
      
      // Bring note to front
      bringToFront(noteId);
      
      const noteElement = document.getElementById(`note-${noteId}`);
      noteElement.classList.add('dragging');
      
      // Calculate offset for relative dragging
      const rect = noteElement.getBoundingClientRect();
      dragOffset = {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
      
      e.preventDefault();
    }

    function handleMouseMove(e) {
      if (!isDragging || !draggedNote) return;
      
      const note = notes.find(n => n.id === draggedNote);
      if (!note) return;
      
      // Calculate new position
      const newX = e.clientX - dragOffset.x;
      const newY = e.clientY - dragOffset.y;
      
      // Update note position visually
      const noteElement = document.getElementById(`note-${draggedNote}`);
      noteElement.style.transform = `translate(${newX}px, ${newY}px)`;
      
      // Update note object
      note.x = newX;
      note.y = newY;
    }

    function stopDrag() {
      if (!isDragging || !draggedNote) return;
      
      const note = notes.find(n => n.id === draggedNote);
      if (note) {
        // Send the final position to the server
        socket.emit('updateNote', note);
      }
      
      // Clean up drag state
      const noteElement = document.getElementById(`note-${draggedNote}`);
      if (noteElement) noteElement.classList.remove('dragging');
      
      isDragging = false;
      draggedNote = null;
    }

    function addNote() {
      activeNoteId = Date.now().toString();
      modalTitle.textContent = 'Crear Nuevo Plan';
      noteTitle.value = '';
      noteContent.value = '';
      noteLink.value = '';
      noteCategory.value = 'other';
      openModal();
    }

    function editNote(noteId) {
      const note = notes.find(n => n.id === noteId);
      if (!note) return;
      
      activeNoteId = noteId;
      modalTitle.textContent = 'Editar Plan';
      noteTitle.value = note.title || '';
      noteContent.value = note.content || '';
      noteLink.value = note.link || '';
      noteCategory.value = note.category || 'other';
      openModal();
    }

    function deleteNote(noteId) {
      socket.emit('deleteNote', noteId);
    }

    function changeNoteCategory(noteId, categoryValue) {
      const note = notes.find(n => n.id === noteId);
      if (!note) return;
      
      note.category = categoryValue;
      note.color = getCategoryClass(categoryValue);
      socket.emit('updateNote', note);
    }

    function toggleMinimize(noteId) {
      const note = notes.find(n => n.id === noteId);
      if (!note) return;
      
      note.minimized = !note.minimized;
      socket.emit('updateNote', note);
    }

    function bringToFront(noteId) {
      const newZIndex = highestZIndex + 1;
      const note = notes.find(n => n.id === noteId);
      if (!note) return;
      
      note.zIndex = newZIndex;
      socket.emit('updateNote', note);
      highestZIndex = newZIndex;
    }

    function saveNote() {
      if (!activeNoteId) return;
      
      const title = noteTitle.value.trim();
      const content = noteContent.value.trim();
      const link = noteLink.value.trim();
      const category = noteCategory.value;
      
      if (!title && !content) return;
      
      const existingNote = notes.find(n => n.id === activeNoteId);
      
      if (existingNote) {
        // Update existing note
        existingNote.title = title;
        existingNote.content = content;
        existingNote.link = link;
        existingNote.category = category;
        existingNote.color = getCategoryClass(category);
        socket.emit('updateNote', existingNote);
      } else {
        // Create new note
        const newZIndex = highestZIndex + 1;
        const newNote = {
          id: activeNoteId,
          title: title,
          content: content,
          link: link,
          category: category,
          color: getCategoryClass(category),
          x: Math.random() * (board.clientWidth * 0.6) + 50,
          y: Math.random() * (board.clientHeight * 0.5) + 50,
          zIndex: newZIndex
        };
        socket.emit('newNote', newNote);
        highestZIndex = newZIndex;
      }
      
      closeModal();
    }

    function openModal() {
      noteModal.classList.add('active');
      noteTitle.focus();
    }

    function closeModal() {
      noteModal.classList.remove('active');
      activeNoteId = null;
    }

    // Toggle dark mode
    function toggleTheme() {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      
      if (isDark) {
        sunIcon.classList.add('hidden');
        moonIcon.classList.remove('hidden');
      } else {
        sunIcon.classList.remove('hidden');
        moonIcon.classList.add('hidden');
      }
      
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    // Set up event listeners
    addNoteBtn.addEventListener('click', addNote);
    saveNoteBtn.addEventListener('click', saveNote);
    cancelBtn.addEventListener('click', closeModal);
    themeToggle.addEventListener('click', toggleTheme);
    
    // Close modal when clicking outside
    noteModal.addEventListener('click', (e) => {
      if (e.target === noteModal) closeModal();
    });
    
    // Allow submitting with Ctrl+Enter in textarea
    noteContent.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        saveNote();
      }
    });
    
    // Set up global mouse move and mouse up for dragging
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', stopDrag);
    
    // Close category picker when clicking outside
    document.addEventListener('click', (e) => {
      if (showCategoryPicker && !e.target.closest('.category-btn') && !e.target.closest('.category-picker')) {
        const categoryPicker = document.querySelector(`#note-${showCategoryPicker} .category-picker`);
        if (categoryPicker) categoryPicker.classList.add('hidden');
        showCategoryPicker = null;
      }
    });

    // Initialize theme from localStorage
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark');
      sunIcon.classList.add('hidden');
      moonIcon.classList.remove('hidden');
    }

    // Initialize with default notes if none exist after 1 second
    setTimeout(() => {
      if (notes.length === 0) {
        const defaultNotes = [
          { 
            id: '1', 
            title: 'Restaurante La Marea',
            content: 'Excelente restaurante de mariscos con vista al mar. Ideal para cenas rom√°nticas.',
            link: 'https://maps.google.com/example-restaurant',
            category: 'restaurant',
            x: 100, 
            y: 100, 
            color: 'category-restaurant',
            zIndex: 1
          },
          { 
            id: '2', 
            title: 'Casa en Airbnb',
            content: 'Hermosa casa con piscina para 6 personas. Disponible del 15 al 22 de julio.',
            link: 'https://airbnb.com/example-house',
            category: 'lodging',
            x: 400, 
            y: 150, 
            color: 'category-lodging',
            zIndex: 2
          },
          { 
            id: '3', 
            title: 'Playa El Para√≠so',
            content: 'Playa con aguas cristalinas y arena blanca. Ideal para snorkel.',
            link: 'https://maps.google.com/example-beach',
            category: 'beach',
            x: 200, 
            y: 300, 
            color: 'category-beach',
            zIndex: 3
          }
        ];
        
        notes = defaultNotes;
        highestZIndex = 3;
        renderAllNotes();
      }
    }, 1000);
  </script>
</body>
</html>