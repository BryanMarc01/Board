<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìù Sticky Notes with WebSockets</title>
  <!-- Socket.io CDN -->
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <style>
    :root {
      --bg-gradient-from: #f8fafc;
      --bg-gradient-to: #f1f5f9;
      --board-bg: #ffffff;
      --board-border: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --note-shadow: rgba(0, 0, 0, 0.1);
      --modal-overlay: rgba(0, 0, 0, 0.5);
      --amber-100: #fef3c7;
      --amber-300: #fcd34d;
      --sky-100: #e0f2fe;
      --sky-300: #7dd3fc;
      --emerald-100: #d1fae5;
      --emerald-300: #6ee7b7;
      --rose-100: #ffe4e6;
      --rose-300: #fda4af;
      --violet-100: #ede9fe;
      --violet-300: #c4b5fd;
      --orange-100: #ffedd5;
      --orange-300: #fdba74;
      --green-100: #dcfce7;
      --green-800: #166534;
      --red-100: #fee2e2;
      --red-500: #ef4444;
      --red-800: #991b1b;
      --white: #ffffff;
      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-300: #cbd5e1;
      --slate-400: #94a3b8;
      --slate-500: #64748b;
      --slate-600: #475569;
      --slate-700: #334155;
      --slate-800: #1e293b;
      --slate-900: #0f172a;
      --slate-950: #020617;
      --radius-sm: 0.25rem;
      --radius-md: 0.375rem;
      --radius-lg: 0.5rem;
      --radius-xl: 0.75rem;
      --radius-full: 9999px;
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    .dark {
      --bg-gradient-from: #0f172a;
      --bg-gradient-to: #1e293b;
      --board-bg: #020617;
      --board-border: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-sans);
      background: linear-gradient(to bottom right, var(--bg-gradient-from), var(--bg-gradient-to));
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      font-size: 16px;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    h1 {
      font-size: 1.875rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .connection-status {
      margin-left: 1rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .status-connected {
      background-color: var(--green-100);
      color: var(--green-800);
    }

    .status-disconnected {
      background-color: var(--red-100);
      color: var(--red-800);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      outline: none;
    }

    .btn-primary {
      background: linear-gradient(to right, #10b981, #14b8a6);
      color: var(--white);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-primary:hover {
      background: linear-gradient(to right, #059669, #0d9488);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-icon {
      width: 1.5rem;
      height: 1.5rem;
      padding: 0;
      border-radius: var(--radius-full);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-ghost {
      background: transparent;
      color: var(--slate-600);
    }

    .btn-ghost:hover {
      background-color: rgba(255, 255, 255, 0.5);
    }

    .btn-danger:hover {
      background-color: var(--red-100);
      color: var(--red-500);
    }

    .icon {
      width: 1rem;
      height: 1rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }

    .icon-sm {
      width: 0.75rem;
      height: 0.75rem;
    }

    .board {
      position: relative;
      width: 100%;
      min-height: calc(100vh - 8rem);
      background-color: var(--board-bg);
      border-radius: var(--radius-xl);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--board-border);
      overflow: hidden;
    }

    .note {
      position: absolute;
      padding: 0;
      border-radius: var(--radius-lg);
      box-shadow: 0 2px 4px var(--note-shadow);
      transition: all 0.2s ease;
      width: 250px;
      border-width: 2px;
      border-style: solid;
    }

    .note.dragging {
      box-shadow: 0 8px 16px var(--note-shadow);
      z-index: 100;
    }

    .note-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem;
      border-bottom: 1px solid;
      border-bottom-color: inherit;
      background-color: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(4px);
    }

    .note-header-left {
      display: flex;
      align-items: center;
    }

    .note-title {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--slate-500);
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-left: 0.5rem;
    }

    .note-actions {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .note-content {
      padding: 0.75rem;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--slate-700);
      min-height: 80px;
      max-height: 200px;
      overflow-y: auto;
    }

    .color-picker {
      position: absolute;
      right: 0.5rem;
      top: 2.5rem;
      background-color: var(--white);
      padding: 0.5rem;
      border-radius: var(--radius-md);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--slate-200);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.25rem;
      z-index: 50;
    }

    .color-option {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: var(--radius-full);
      cursor: pointer;
      border: 1px solid var(--slate-300);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--modal-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 28rem;
      transform: scale(0.95);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: scale(1);
      opacity: 1;
    }

    .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--slate-200);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--slate-800);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--slate-200);
    }

    .textarea {
      width: 100%;
      min-height: 150px;
      resize: none;
      border: 1px solid var(--slate-300);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      font-family: inherit;
      font-size: 1rem;
      color: var(--slate-800);
      outline: none;
      transition: border-color 0.2s ease;
    }

    .textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .keyboard-hint {
      font-size: 0.75rem;
      color: var(--slate-500);
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
    }

    .btn-secondary {
      background-color: var(--white);
      color: var(--slate-800);
      border: 1px solid var(--slate-300);
    }

    .btn-secondary:hover {
      background-color: var(--slate-100);
    }

    .hidden {
      display: none;
    }

    /* Note colors */
    .bg-amber-100 {
      background-color: var(--amber-100);
      border-color: var(--amber-300);
    }

    .bg-sky-100 {
      background-color: var(--sky-100);
      border-color: var(--sky-300);
    }

    .bg-emerald-100 {
      background-color: var(--emerald-100);
      border-color: var(--emerald-300);
    }

    .bg-rose-100 {
      background-color: var(--rose-100);
      border-color: var(--rose-300);
    }

    .bg-violet-100 {
      background-color: var(--violet-100);
      border-color: var(--violet-300);
    }

    .bg-orange-100 {
      background-color: var(--orange-100);
      border-color: var(--orange-300);
    }

    /* Responsive styles */
    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .note {
        width: 200px;
      }
    }

    /* Dark mode toggle */
    .theme-toggle {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background-color: var(--white);
      border: 1px solid var(--slate-200);
      border-radius: var(--radius-full);
      padding: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      z-index: 10;
    }

    .dark .theme-toggle {
      background-color: var(--slate-800);
      border-color: var(--slate-700);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <h1>üìù Sticky Notes</h1>
        <div id="connectionStatus" class="connection-status status-disconnected">Disconnected</div>
      </div>
      <button id="addNoteBtn" class="btn btn-primary">
        <svg class="icon mr-2" viewBox="0 0 24 24">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add Note
      </button>
    </header>

    <div id="board" class="board">
      <!-- Notes will be dynamically added here -->
    </div>
  </div>

  <!-- Modal for creating/editing notes -->
  <div id="noteModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle" class="modal-title">Create New Note</h3>
      </div>
      <div class="modal-body">
        <textarea id="noteContent" class="textarea" placeholder="Write your note here..."></textarea>
      </div>
      <div class="modal-footer">
        <div class="keyboard-hint">Press Ctrl+Enter to save</div>
        <div class="btn-group">
          <button id="cancelBtn" class="btn btn-secondary">Cancel</button>
          <button id="saveNoteBtn" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dark mode toggle -->
  <button id="themeToggle" class="theme-toggle">
    <svg id="sunIcon" class="icon" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
    <svg id="moonIcon" class="icon hidden" viewBox="0 0 24 24">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </button>

  <script>
    // DOM Elements
    const board = document.getElementById('board');
    const noteModal = document.getElementById('noteModal');
    const modalTitle = document.getElementById('modalTitle');
    const noteContent = document.getElementById('noteContent');
    const addNoteBtn = document.getElementById('addNoteBtn');
    const saveNoteBtn = document.getElementById('saveNoteBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const themeToggle = document.getElementById('themeToggle');
    const sunIcon = document.getElementById('sunIcon');
    const moonIcon = document.getElementById('moonIcon');

    // Application State
    let notes = [];
    let activeNoteId = null;
    let isDragging = false;
    let draggedNote = null;
    let dragOffset = { x: 0, y: 0 };
    let highestZIndex = 1;
    let showColorPicker = null;

    // Available colors for notes
    const noteColors = [
      { class: 'bg-amber-100', name: 'Amber' },
      { class: 'bg-sky-100', name: 'Sky' },
      { class: 'bg-emerald-100', name: 'Emerald' },
      { class: 'bg-rose-100', name: 'Rose' },
      { class: 'bg-violet-100', name: 'Violet' },
      { class: 'bg-orange-100', name: 'Orange' }
    ];

    // Initialize Socket.io
    const socket = io("https://backend-devnotess.onrender.com");

    // Socket.io event handlers
    socket.on('connect', () => {
      console.log('‚úÖ Connected to server');
      connectionStatus.textContent = 'Connected';
      connectionStatus.classList.remove('status-disconnected');
      connectionStatus.classList.add('status-connected');
    });

    socket.on('disconnect', () => {
      connectionStatus.textContent = 'Disconnected';
      connectionStatus.classList.remove('status-connected');
      connectionStatus.classList.add('status-disconnected');
    });

    socket.on('loadNotes', loadedNotes => {
      notes = loadedNotes.map(note => ({
        ...note,
        color: note.color || 'bg-amber-100',
        zIndex: note.zIndex || 1,
        minimized: note.minimized || false
      }));
      
      // Find highest z-index
      highestZIndex = Math.max(...notes.map(n => n.zIndex || 1), 1);
      renderAllNotes();
    });

    socket.on('newNote', note => {
      const newNote = {
        ...note,
        color: note.color || 'bg-amber-100',
        zIndex: note.zIndex || highestZIndex + 1,
        minimized: note.minimized || false
      };
      notes.push(newNote);
      renderNote(newNote);
      highestZIndex = Math.max(highestZIndex, newNote.zIndex);
    });

    socket.on('updateNote', updatedNote => {
      notes = notes.map(note => 
        note.id === updatedNote.id ? {
          ...updatedNote,
          zIndex: updatedNote.zIndex || note.zIndex,
          minimized: updatedNote.minimized !== undefined ? updatedNote.minimized : note.minimized
        } : note
      );
      
      updateNoteElement(updatedNote);
      
      if (updatedNote.zIndex && updatedNote.zIndex > highestZIndex) {
        highestZIndex = updatedNote.zIndex;
      }
    });

    socket.on('deleteNote', noteId => {
      notes = notes.filter(note => note.id !== noteId);
      const noteElement = document.getElementById(`note-${noteId}`);
      if (noteElement) noteElement.remove();
    });

    // Functions to handle notes
    function renderAllNotes() {
      board.innerHTML = '';
      notes.forEach(renderNote);
    }

    function renderNote(note) {
      // Check if note already exists
      const existingNote = document.getElementById(`note-${note.id}`);
      if (existingNote) {
        updateNoteElement(note);
        return;
      }

      // Create note element
      const noteElement = document.createElement('div');
      noteElement.id = `note-${note.id}`;
      noteElement.className = `note ${note.color || 'bg-amber-100'}`;
      noteElement.style.transform = `translate(${note.x}px, ${note.y}px)`;
      noteElement.style.zIndex = note.zIndex || 1;
      
      // Note header with title and actions
      const headerHTML = `
        <div class="note-header">
          <div class="note-header-left">
            <svg class="icon icon-sm" viewBox="0 0 24 24">
              <line x1="4" y1="9" x2="20" y2="9"></line>
              <line x1="4" y1="15" x2="20" y2="15"></line>
            </svg>
            <span class="note-title">${note.content.split('\n')[0]}</span>
          </div>
          <div class="note-actions">
            <button class="btn btn-icon btn-ghost color-btn" title="Change color">
              <svg class="icon icon-sm" viewBox="0 0 24 24">
                <circle cx="13.5" cy="6.5" r="2.5"></circle>
                <circle cx="19" cy="13" r="2.5"></circle>
                <circle cx="6" cy="12" r="2.5"></circle>
                <circle cx="12" cy="19" r="2.5"></circle>
              </svg>
            </button>
            <button class="btn btn-icon btn-ghost edit-btn" title="Edit note">
              <svg class="icon icon-sm" viewBox="0 0 24 24">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
            <button class="btn btn-icon btn-ghost minimize-btn" title="${note.minimized ? 'Maximize' : 'Minimize'}">
              <svg class="icon icon-sm ${note.minimized ? 'hidden' : ''}" viewBox="0 0 24 24">
                <polyline points="8 3 18 3 18 13"></polyline>
                <polyline points="16 8 21 3 16 8"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
              <svg class="icon icon-sm ${note.minimized ? '' : 'hidden'}" viewBox="0 0 24 24">
                <polyline points="15 3 21 3 21 9"></polyline>
                <polyline points="9 21 3 21 3 15"></polyline>
                <line x1="21" y1="3" x2="14" y2="10"></line>
                <line x1="3" y1="21" x2="10" y2="14"></line>
              </svg>
            </button>
            <button class="btn btn-icon btn-ghost btn-danger delete-btn" title="Delete note">
              <svg class="icon icon-sm" viewBox="0 0 24 24">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </div>
        <div class="color-picker hidden"></div>
      `;
      
      noteElement.innerHTML = headerHTML;
      
      // Add note content if not minimized
      if (!note.minimized) {
        const contentDiv = document.createElement('div');
        contentDiv.className = 'note-content';
        contentDiv.textContent = note.content;
        noteElement.appendChild(contentDiv);
      }
      
      board.appendChild(noteElement);
      
      // Set up color picker
      const colorPicker = noteElement.querySelector('.color-picker');
      noteColors.forEach(color => {
        const colorOption = document.createElement('div');
        colorOption.className = `color-option ${color.class}`;
        colorOption.title = color.name;
        
        // Add checkmark if this is the current color
        if (note.color === color.class) {
          colorOption.innerHTML = `
            <svg class="icon icon-sm" viewBox="0 0 24 24">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `;
        }
        
        colorOption.addEventListener('click', () => {
          changeNoteColor(note.id, color.class);
          colorPicker.classList.add('hidden');
        });
        
        colorPicker.appendChild(colorOption);
      });
      
      // Set up event handlers
      setupNoteEvents(noteElement, note.id);
    }

    function updateNoteElement(note) {
      const noteElement = document.getElementById(`note-${note.id}`);
      if (!noteElement) return;
      
      // Update position and z-index
      noteElement.style.transform = `translate(${note.x}px, ${note.y}px)`;
      noteElement.style.zIndex = note.zIndex || 1;
      
      // Update title
      const titleElement = noteElement.querySelector('.note-title');
      if (titleElement) {
        titleElement.textContent = note.content.split('\n')[0];
      }
      
      // Update color
      noteElement.className = `note ${note.color || 'bg-amber-100'}`;
      
      // Update minimize/maximize state
      const minimizeBtn = noteElement.querySelector('.minimize-btn');
      const minimizeIconHide = minimizeBtn.querySelector('svg:first-child');
      const maximizeIconHide = minimizeBtn.querySelector('svg:last-child');
      
      if (note.minimized) {
        minimizeIconHide.classList.add('hidden');
        maximizeIconHide.classList.remove('hidden');
        
        // Remove content if minimized
        const contentElement = noteElement.querySelector('.note-content');
        if (contentElement) {
          contentElement.remove();
        }
      } else {
        minimizeIconHide.classList.remove('hidden');
        maximizeIconHide.classList.add('hidden');
        
        // Add content if not minimized and doesn't exist
        if (!noteElement.querySelector('.note-content')) {
          const contentDiv = document.createElement('div');
          contentDiv.className = 'note-content';
          contentDiv.textContent = note.content;
          noteElement.appendChild(contentDiv);
        } else {
          // Update content if it exists
          const contentElement = noteElement.querySelector('.note-content');
          contentElement.textContent = note.content;
        }
      }
    }

    function setupNoteEvents(noteElement, noteId) {
      // Edit button
      noteElement.querySelector('.edit-btn').addEventListener('click', () => {
        editNote(noteId);
      });
      
      // Delete button
      noteElement.querySelector('.delete-btn').addEventListener('click', () => {
        deleteNote(noteId);
      });
      
      // Color button
      noteElement.querySelector('.color-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const colorPicker = noteElement.querySelector('.color-picker');
        
        // Close any other open color pickers
        if (showColorPicker && showColorPicker !== noteId) {
          const otherPicker = document.querySelector(`#note-${showColorPicker} .color-picker`);
          if (otherPicker) otherPicker.classList.add('hidden');
        }
        
        colorPicker.classList.toggle('hidden');
        showColorPicker = colorPicker.classList.contains('hidden') ? null : noteId;
      });
      
      // Minimize/Maximize button
      noteElement.querySelector('.minimize-btn').addEventListener('click', () => {
        toggleMinimize(noteId);
      });
      
        () => {
        toggleMinimize(noteId);
      };
      
      // Drag events
      noteElement.addEventListener('mousedown', (e) => {
        // Don't start drag if clicked on a button
        if (e.target.closest('button')) return;
        
        startDrag(e, noteId);
      });
      
      // Bring to front on click
      noteElement.addEventListener('click', () => {
        bringToFront(noteId);
      });
    }

    function startDrag(e, noteId) {
      const note = notes.find(n => n.id === noteId);
      if (!note) return;
      
      isDragging = true;
      draggedNote = noteId;
      
      // Bring note to front
      bringToFront(noteId);
      
      const noteElement = document.getElementById(`note-${noteId}`);
      noteElement.classList.add('dragging');
      
      // Calculate offset for relative dragging
      const rect = noteElement.getBoundingClientRect();
      dragOffset = {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
      
      e.preventDefault();
    }

    function handleMouseMove(e) {
      if (!isDragging || !draggedNote) return;
      
      const note = notes.find(n => n.id === draggedNote);
      if (!note) return;
      
      // Calculate new position
      const newX = e.clientX - dragOffset.x;
      const newY = e.clientY - dragOffset.y;
      
      // Update note position visually
      const noteElement = document.getElementById(`note-${draggedNote}`);
      noteElement.style.transform = `translate(${newX}px, ${newY}px)`;
      
      // Update note object
      note.x = newX;
      note.y = newY;
    }

    function stopDrag() {
      if (!isDragging || !draggedNote) return;
      
      const note = notes.find(n => n.id === draggedNote);
      if (note) {
        // Send the final position to the server
        socket.emit('updateNote', note);
      }
      
      // Clean up drag state
      const noteElement = document.getElementById(`note-${draggedNote}`);
      if (noteElement) noteElement.classList.remove('dragging');
      
      isDragging = false;
      draggedNote = null;
    }

    function addNote() {
      activeNoteId = Date.now().toString();
      modalTitle.textContent = 'Create New Note';
      noteContent.value = '';
      openModal();
    }

    function editNote(noteId) {
      const note = notes.find(n => n.id === noteId);
      if (!note) return;
      
      activeNoteId = noteId;
      modalTitle.textContent = 'Edit Note';
      noteContent.value = note.content;
      openModal();
    }

    function deleteNote(noteId) {
      socket.emit('deleteNote', noteId);
    }

    function changeNoteColor(noteId, colorClass) {
      const note = notes.find(n => n.id === noteId);
      if (!note) return;
      
      note.color = colorClass;
      socket.emit('updateNote', note);
    }

    function toggleMinimize(noteId) {
      const note = notes.find(n => n.id === noteId);
      if (!note) return;
      
      note.minimized = !note.minimized;
      socket.emit('updateNote', note);
    }

    function bringToFront(noteId) {
      const newZIndex = highestZIndex + 1;
      const note = notes.find(n => n.id === noteId);
      if (!note) return;
      
      note.zIndex = newZIndex;
      socket.emit('updateNote', note);
      highestZIndex = newZIndex;
    }

    function saveNote() {
      if (!activeNoteId) return;
      
      const content = noteContent.value.trim();
      if (!content) return;
      
      const existingNote = notes.find(n => n.id === activeNoteId);
      
      if (existingNote) {
        // Update existing note
        existingNote.content = content;
        socket.emit('updateNote', existingNote);
      } else {
        // Create new note
        const newZIndex = highestZIndex + 1;
        const newNote = {
          id: activeNoteId,
          content,
          x: Math.random() * (board.clientWidth * 0.6) + 50,
          y: Math.random() * (board.clientHeight * 0.5) + 50,
          color: 'bg-amber-100',
          zIndex: newZIndex
        };
        socket.emit('newNote', newNote);
        highestZIndex = newZIndex;
      }
      
      closeModal();
    }

    function openModal() {
      noteModal.classList.add('active');
      noteContent.focus();
    }

    function closeModal() {
      noteModal.classList.remove('active');
      activeNoteId = null;
    }

    // Toggle dark mode
    function toggleTheme() {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      
      if (isDark) {
        sunIcon.classList.add('hidden');
        moonIcon.classList.remove('hidden');
      } else {
        sunIcon.classList.remove('hidden');
        moonIcon.classList.add('hidden');
      }
      
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    // Set up event listeners
    addNoteBtn.addEventListener('click', addNote);
    saveNoteBtn.addEventListener('click', saveNote);
    cancelBtn.addEventListener('click', closeModal);
    themeToggle.addEventListener('click', toggleTheme);
    
    // Close modal when clicking outside
    noteModal.addEventListener('click', (e) => {
      if (e.target === noteModal) closeModal();
    });
    
    // Allow submitting with Ctrl+Enter in textarea
    noteContent.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        saveNote();
      }
    });
    
    // Set up global mouse move and mouse up for dragging
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', stopDrag);
    
    // Close color picker when clicking outside
    document.addEventListener('click', (e) => {
      if (showColorPicker && !e.target.closest('.color-btn') && !e.target.closest('.color-picker')) {
        const colorPicker = document.querySelector(`#note-${showColorPicker} .color-picker`);
        if (colorPicker) colorPicker.classList.add('hidden');
        showColorPicker = null;
      }
    });

    // Initialize theme from localStorage
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark');
      sunIcon.classList.add('hidden');
      moonIcon.classList.remove('hidden');
    }

    // Initialize with default notes if none exist after 1 second
    setTimeout(() => {
      if (notes.length === 0) {
        const defaultNotes = [
          { 
            id: '1', 
            content: 'Welcome to Sticky Notes!\n\nDrag this note to move it.', 
            x: 100, 
            y: 100, 
            color: 'bg-amber-100',
            zIndex: 1
          },
          { 
            id: '2', 
            content: 'Click the edit button to modify content.', 
            x: 400, 
            y: 150, 
            color: 'bg-sky-100',
            zIndex: 2
          },
          { 
            id: '3', 
            content: 'Change note colors with the palette button.', 
            x: 200, 
            y: 300, 
            color: 'bg-emerald-100',
            zIndex: 3
          }
        ];
        
        notes = defaultNotes;
        highestZIndex = 3;
        renderAllNotes();
      }
    }, 1000);
  </script>
</body>
</html>